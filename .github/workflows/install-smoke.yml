name: Install Smoke Tests

on:
  push:
    branches:
      - master
  pull_request:

jobs:
  unix-install-smoke:
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - macos-latest
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run installer (first pass)
        shell: bash
        run: |
          set -euo pipefail
          CT_HOME="$RUNNER_TEMP/claude-trinity-home"
          mkdir -p "$CT_HOME"
          HOME="$CT_HOME" bash ./install.sh --yes --skip-claude-mem

      - name: Run installer (idempotency pass)
        shell: bash
        run: |
          set -euo pipefail
          CT_HOME="$RUNNER_TEMP/claude-trinity-home"
          HOME="$CT_HOME" bash ./install.sh --yes --skip-claude-mem

      - name: Verify installed files
        shell: bash
        run: |
          set -euo pipefail
          CT_HOME="$RUNNER_TEMP/claude-trinity-home"
          test -f "$CT_HOME/.claude/memory/MEMORY.md"
          test -f "$CT_HOME/.claude/memory/crossmem.md"
          test -f "$CT_HOME/.claude/memory/facts/example-project.json"
          test -f "$CT_HOME/.claude/memory/methodology/methodology.md"
          test -f "$CT_HOME/.claude/rules/example-docker.md"
          test -f "$CT_HOME/.claude/settings.json"
          grep -F '2>/dev/null || true' "$CT_HOME/.claude/settings.json"

  windows-install-smoke:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run installer (first pass)
        shell: pwsh
        run: |
          $ctHome = Join-Path $env:RUNNER_TEMP "claude-trinity-home"
          New-Item -ItemType Directory -Path $ctHome -Force | Out-Null
          $env:USERPROFILE = $ctHome
          .\install.ps1 -Yes -SkipClaudeMem

      - name: Run installer (idempotency pass)
        shell: pwsh
        run: |
          $ctHome = Join-Path $env:RUNNER_TEMP "claude-trinity-home"
          $env:USERPROFILE = $ctHome
          .\install.ps1 -Yes -SkipClaudeMem

      - name: Verify installed files
        shell: pwsh
        run: |
          $ctHome = Join-Path $env:RUNNER_TEMP "claude-trinity-home"
          $settings = Join-Path $ctHome ".claude\settings.json"
          $requiredFiles = @(
            (Join-Path $ctHome ".claude\memory\MEMORY.md"),
            (Join-Path $ctHome ".claude\memory\crossmem.md"),
            (Join-Path $ctHome ".claude\memory\facts\example-project.json"),
            (Join-Path $ctHome ".claude\memory\methodology\methodology.md"),
            (Join-Path $ctHome ".claude\rules\example-docker.md"),
            $settings
          )
          foreach ($file in $requiredFiles) {
            if (-not (Test-Path $file)) {
              throw "Missing expected file: $file"
            }
          }
          $settingsContent = Get-Content -Raw $settings
          if ($settingsContent -notmatch "powershell -NoProfile -Command") {
            throw "Expected Windows hook command not found in settings.json"
          }

      - name: Verify SessionStart hook simulation
        shell: pwsh
        run: |
          .\scripts\verify-hooks.ps1
